<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Documentation{% endblock %}</title>
</head>

<body>
    <nav>
        <ul id="nav-links">
            <!-- {% if user.is_authenticated %}
            <li><a onclick="fetchUserProfile()">Profile</a></li>
            <li><a onclick="logoutUser()">Logout</a></li>
            {% else %}
            <li><a href="{% url 'login' %}">Login</a></li>
            <li><a href="{% url 'register' %}">Register</a></li>
            {% endif %} -->
        </ul>
    </nav>

    <div id="content">
        {% block content %}
        {% endblock %}
    </div>

    <script>
        async function updateNavigation() {
            const user = await checkAuthStatus();

            if (user) {
                // If the user is authenticated, show profile and logout options
                document.getElementById('nav-links').innerHTML = `
                    <li><a onclick="fetchUserProfile()">Profile</a></li>
                    <li><a onclick="logoutUser()">Logout</a></li>
                `;
            } else {
                // If the user is not authenticated, show login and register options
                document.getElementById('nav-links').innerHTML = `
                    <li><a href="{% url 'login' %}">Login</a></li>
                    <li><a href="{% url 'register' %}">Register</a></li>
                `;
            }
        }

        async function fetchUserProfile() {
            const token = localStorage.getItem('access_token');
            if (token) {
                const response = await fetch("{% url 'user-profile' %}", {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('User Profile:', data);
                    alert('User profile fetched successfully!');
                } else {
                    alert('Error fetching user profile. Please try again.');
                }
            } else {
                alert('You are not authenticated.');
            }
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                return null;
            }

            const response = await fetch("{% url 'user-profile' %}", {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (response.ok) {
                return await response.json();
            } else {
                return null;
            }
        }

        async function logoutUser() {
            const accessToken = localStorage.getItem("access_token");
            const refreshToken = localStorage.getItem("refresh_token");

            if (!accessToken || !refreshToken) {
                alert("You are not authenticated.");
                return;
            }

            const response = await fetch("{% url 'logout' %}", {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (response.ok) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = "/account/login/";
            } else {
                alert("Logout failed. Please try again.");
            }
        }
    </script>
</body>

</html>